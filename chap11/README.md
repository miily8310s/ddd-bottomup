# 第１１章　アプリケーションを１から組み立てる

- 理解を深めるためにアプリケーションを最初から組み立てる過程を確認する
- ここまでドメイン駆動設計に登場する多くのパターンとソフトウェアとして成り立たせるために必要な要素の解説をしてきた
- ものごとを会得するためにはまず把握をし、そしてそれを反復することが大事
- この章では理解をより深めるために、これまでのパターンを使って実装の練習をする

## 11-1 アプリケーションを組み立てるフロー

- この章ではこれまで登場した要素を使って、新たな機能をアプリケーションに追加する
  - 実践的な手順に沿って進めていく
- 実装を始める前にどういった手順で進めるか確認する
  1. どういった機能が求められているか、の確認
  2. 追加する機能が定まったら、今度はその機能を成り立たせるために必要となるユースケースを洗い出す
  3. ユースケースが揃ったら、必要となる概念とそこに存在するルールからアプリケーションが必要となる知識を選び出し、ドメインオブジェクトを準備する
  4. ドメインオブジェクトを用いてユースケースを実現するアプリケーションサービスを実装する
- この手順が唯一のものではないが、本章ではこの手順に従う

## 11-2 題材とする機能

- これまでは SNS のユーザ機能を題材にしてきたが、まだユーザ登録だけしか出来なかった
- そこでここではユーザ同士の交流を促すために、サークル機能を作って行く

### サークル機能の分析

- サークル機能の実現のために必要なユースケースは以下の２つ
  - 「サークルの作成」
  - 「サークルへの参加」
- 「サークルからの脱退」・「サークルの削除」といったユースケースも考えられるが、今回はこの２つだけを実装する
- 次にサークルの前提条件（ルール）を確認
  1. サークル名は３文字以上２０文字以下
  2. サークル名はすべてのサークルで重複しない
  3. サークルに所属するユーザの最大数はサークルのオーナーとなるユーザを含めて３０名まで
- これらのルールを踏まえて２つのユースケースを組み立てて行く

## 11-3 サークルの知識やルールをオブジェクトとして準備する

[サンプルコード](https://github.com/miily8310s/ddd-bottomup/blob/master/chap11/SampleCodes/)

- サークルに知識・ルールをコードとして表現していく
- まずはサークルを構成する要素 = エンティティを作成する
- サークルはライフサイクルのあるオブジェクト
  - なので識別子を値オブジェクトとして実装する（サンプルコードの CircleId）
  - またサークル名の値オブジェクトも用意する（サンプルコードの CircleName）
- サークル名には次のルールがある。これらも上記の値オブジェクトに盛り込んでいる
  - 「サークル名は３文字以上２０文字以下」
  - 「サークル名はすべてのサークルで重複しない」
- 上記値オブジェクトを利用してライフサイクルをもったオブジェクトであるサークルエンティティを用意
- 次にサークルの永続化を行うために必要となるリポジトリも用意（サンプルコードの ICircleRepository）
- サークルを生成するファクトリも同様に準備（サンプルコードの ICircleFactory）
- サークル名の重複を確認する振る舞いをドメインサービスとして定義（サンプルコードの CircleService）
- 以上で値オブジェクトからドメインサービスまで一通りのオブジェクトの用意が完了

## 11-4 ユースケースを組み立てる

[サンプルコード](https://github.com/miily8310s/ddd-bottomup/blob/master/chap11/SampleCodes/)

- 最初はサークルを作成する処理を実装する
  - まずはコマンドオブジェクトを準備する（サンプルコードの CircleCreateCommand）
  - このコマンドオブジェクトを使って、サークルの作成処理を追加する（サンプルコードの CircleApplicationService）
- 次にサークルに参加するユーザの ID と参加先のサークルの ID を指定し、サークル参加処理を作成
  - 「サークルに所属するユーザの最大数はサークルのオーナーとなるユーザを含めて３０名まで」のルールにあっているかも確認
  - これで問題なければユーザをサークルに参加させる仕組み
- 一方でサンプルコードの`circle.getMembers().length >= 29`の記述に違和感が出ている

### 言葉との齟齬が引き起こす事態

- 言葉とコードでルールの表現に齟齬が起こっている
  - 言葉では「サークルに所属するユーザの最大数はサークルのオーナーとなるユーザを含めて３０名まで」
  - 一方コードでは`circle.getMembers().length >= 29`
  - ３０に対し２９と表現している（２９はサークルのオーナーを抜いたサークルメンバー人数）
- これでは Circle クラスの事情を知らない開発者が２９を３０に書き換える恐れがある
- クラス内の事情を外部に漏らすことは可能な限り避けるべき

### 漏れ出したルールがもたらすもの

- 「サークルに所属するユーザの最大数はサークルのオーナーとなるユーザを含めて３０名まで」はドメインのルールとして重要
- 本来であればドメインオブジェクトに記述すべき
  - これに反してしまうと同じルールが複数箇所に重複して記述されてしまう
  - ルールがプロダクトのあちこちに点在してしまうと、ルールの変更に対する修正箇所も散らばることになり、修正作業の難易度は上昇していく
  - 点在する原因はルールに関わるコードがサービスに記述されてしまっているから
  - これを解決するために必要な知識は第１２章で登場する「集約」という考え方

## 11-5 まとめ

- 実際にソフトウェアを開発する際にも、トップダウンで機能を洗い出し、実装はボトムアップにドメインの知識を表現するドメインオブジェクトを定義し、ユースケースの実装に望む流れを汲むことは多い
- テーマとなる機能を決めて、実現するにはド行ったユースケースが必要か、登場する知識は何かを考え、コードで実現する練習を繰り返すべき
  - 練習することでより理解を深めることができる
- 次の章では本章の最後に現れたロジックが点在してしまうといった問題を解決する「集約」を解説する
- 「集約」はドメイン駆動設計を構成する要素の中では比較的難しい部類になる
