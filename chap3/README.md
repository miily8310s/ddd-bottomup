# ３章 ライフサイクルのあるオブジェクト「エンティティ」

- ドメイン駆動設計におけるエンティティと、ER 図に登場するエンティティは全くの別物

## 3-1 エンティティとは

- ドメイン駆動設計におけるエンティティ=ドメインモデルを実装したドメインオブジェクト
  - 第２章で登場した値オブジェクトもドメインモデルを実装したドメインオブジェクトの一つ
  - 値オブジェクトと（ドメイン駆動設計における）エンティティの違いは「同一性について識別されるか否か」
- 同一性とは？
  - ソフトウェアシステムのユーザーを例に考えてみる
  - ユーザーの情報は最初にユーザー登録を行い、任意でその登録内容を更新する。更新されてもそのユーザーが全く別のユーザーになることはない
    - ユーザーは属性（例：登録名、ID など）ではなく同一性（identity）によって識別される

## 3-2 エンティティの性質について

- エンティティの性質は以下の３つ

  - 可変である
  - 同じ属性であっても区別される
  - 同一性によって区別される

- （参考）値オブジェクトの性質

  - 不変である
  - 交換が可能である
  - 等価性によって比較される

- たとえば姓と名の属性からなる氏名は、そのいずれかの属性が変更されたら全く異なるものになる（=逆に属性が全く同じなら同じものとみなされる）
  - 氏名は属性によって識別されているオブジェクトのため、氏名は値オブジェクトに分類される

### 不変である

- エンティティの属性は不変だった値オブジェクトとは逆で、変化することが許容されている
- ユーザー名の変更を例にみていく
  - サンプルコードは UnChangedEntityUser クラス
  - changeUserName を使用することでユーザー名の変更が可能になった
- 値オブジェクトでは代入によって変更を表現した（不変の性質のため）
- エンティティでは交換ではなく、ふるまい（メソッド）によって属性を変更する
- ただしエンティティの属性はすべて可変にする必要はない。可能な限り不変にすべき

### 同じ属性であっても区別される

- 値オブジェクトでは同じ属性であれば同じものの扱いだった
- エンティティではそれと異なり、同じ属性であっても区別される
- 人間の氏名を例に確認してみる
  - 値オブジェクトでは姓の値と名の値がそれぞれ同じ氏名オブジェクト同士（同姓同名）は同じ物とみなされる
    - しかし人間は同姓同名だから同一人物である、にはならない
    - 人間は属性だけで区別できない、なにで区別するとなると哲学的な話になってしまう
    - エンティティでは「同一性」で識別することになっている
- サンプルコードは IdentifiedUserId/IdentifiedUser クラス
  - 全く同じ名前のユーザーがいても、それが同一のユーザーか別のユーザーかがこれで識別される

### 同一性をもつ

- たいていのシステムではユーザー名が異なっても、変更前後のユーザーは同一に扱いたい
- オブジェクト（今回ならユーザー）の属性が異なっていたとしても、同一かどうか判定するための手段が必要
  - プログラムではその判定に識別子を用いる
- サンプルコードは HaveIdentifiedUserId/HaveIdentifiedUser クラス
  - 識別子として ユーザー ID を指定。ユーザーの同一判定はこの ID が同一かで判定

## 3-3 エンティティの判断基準としてのライフサイクルと連続性

- 値オブジェクトとエンティティはドメインの概念を表すオブジェクトとして似通っている
- 値オブジェクト・エンティティどちらにするかの判断基準がほしい
  - ライフサイクルが存在し、そこに連続性が存在するかが大きな判断基準になる
    - システムのユーザーは作成される → ユーザー名などが更新される → 月日が流れて不要になったタイミングで削除される
    - なのでシステムのユーザーはライフサイクルが存在し、そこに連続性が存在すると言える。エンティティに分類して OK
  - ライフサイクルのないものは値オブジェクトに分類して OK
- ライフサイクルのあるオブジェクトは生まれてから死ぬまで変化し続けるので取り扱いは慎重に
- 不変にできるオブジェクトは可能な限り不変のままで扱うべき

## 3-4 値オブジェクトとエンティティのどちらにもなりうるモデル

- エンティティにも値オブジェクトにもなりえる概念は存在する
  - ものごとを取り巻く環境によってどちらが適切か変わるため
- タイヤを例にする
  - 車にとってはタイヤはパーツであり、交換可能なもの。よって値オブジェクトが適切
  - 一方タイヤを製造する工場にとっては、タイヤはロットによっていつ作られたものであるかなどで個体を識別することが重要になる。よってエンティティの方が適切になる

## 3-5 ドメインオブジェクトを定義するメリット

- ドメインオブジェクトを定義するメリットは次の２つ
  - コードのドキュメント性が高まる
  - ドメインにおける変更をコードに伝えやすくする

TODO: 3-5 の詳細を記載する

### コードのドキュメント性が高まる

### ドメインにおける変更をコードに伝えやすくする

## 3-6 まとめ

- 豊かな振る舞いをもったオブジェクトはソフトウェアがどのドメインの知識に関心があるか、それをどのように識別しているかを浮き彫りにする
  - 後続の開発者にもドメインを理解する有効な手がかりにもなる
- ドメインに対する洞察は実装時にも現れる
  - エンティティの実装で曖昧さを感じたら、ドメインの捉え方を見つめ直すべき
