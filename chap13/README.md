# 第１３章 複雑な条件を表現する「仕様」

- 仕様：オブジェクトの評価を行うオブジェクト
- オブジェクトの評価はときに複雑な手順が必要になる
  - こうした評価処理をオブジェクトのメソッドに盛り込むと、オブジェクト本来の趣旨が見えづらくなることがある
- 評価処理はそれ事態をオブジェクトとして切り出すことができる

## 13-1 仕様とは

- オブジェクトの評価はすべてが単純な処理とは限らない
  - オブジェクトのメソッドとして定義するには似つかわしくない
- そういった複雑な評価はアプリケーションサービスに記述されてしまうことがある
  - しかし、オブジェクトの評価はドメインの重要なルール
  - アプリケーションサービスに記述されると問題
- 対策として仕様（あるオブジェクトが評価を満たしているか確認するオブジェクト）を設置する
- まずは複雑な評価を例にし、仕様がどういったものかを確認していく

### 複雑な評価処理を確認する

- サークルの人数上限が、所属ユーザのタイプにより変動するとする

  ```
    - ユーザにはプレミアムユーザと呼ばれるタイプが存在する
    - サークルに所属するユーザの最大数はサークルのオーナーとなるユーザを含めて３０名まで
    - プレミアムユーザが１０名以上所属しているサークルはメンバーの最大数が５０名に引き上げられる
  ```

- アプリケーションサービスにドメインのルールに基づくロジックを記述する必要がある
  - でないとドメインオブジェクトはルールを何も語らない
  - かつドメインの重要なルールはサービスのあちらこちらに記述されるようになってしまう
- Circle クラスに書きたいところだが、ユーザ情報は識別子（UserId）しか保持していない
  - 識別子からユーザ情報を取得するにはリポジトリが必要
- エンティティや値オブジェクトがドメインモデルの表現に専念するためには、リポジトリを操作することを可能な限り避ける必要がある

### 「仕様」による解決

- エンティティや値オブジェクトにリポジトリを操作させないため、サークルが満員かの評価を「仕様」として切り出す
  - 複雑な評価手順を切り出すことで趣旨が明確になる

### リポジトリの仕様を避ける

- 仕様=ドメインオブジェクト内部でリポジトリを使用することを避ける考え方もある
- ファーストクラスコレクションを利用する選択
  - ファーストクラスコレクション=特化した集合オブジェクトを用意するパターン

## 13-2 仕様とリポジトリを組み合わせる
