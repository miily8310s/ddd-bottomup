# 第１３章 複雑な条件を表現する「仕様」

- 仕様：オブジェクトの評価を行うオブジェクト
- オブジェクトの評価はときに複雑な手順が必要になる
  - こうした評価処理をオブジェクトのメソッドに盛り込むと、オブジェクト本来の趣旨が見えづらくなることがある
- 評価処理はそれ事態をオブジェクトとして切り出すことができる

## 13-1 仕様とは

- オブジェクトの評価はすべてが単純な処理とは限らない
  - オブジェクトのメソッドとして定義するには似つかわしくない
- そういった複雑な評価はアプリケーションサービスに記述されてしまうことがある
  - しかし、オブジェクトの評価はドメインの重要なルール
  - アプリケーションサービスに記述されると問題
- 対策として仕様（あるオブジェクトが評価を満たしているか確認するオブジェクト）を設置する
- まずは複雑な評価を例にし、仕様がどういったものかを確認していく

### 複雑な評価処理を確認する

- サークルの人数上限が、所属ユーザのタイプにより変動するとする

  ```
    - ユーザにはプレミアムユーザと呼ばれるタイプが存在する
    - サークルに所属するユーザの最大数はサークルのオーナーとなるユーザを含めて３０名まで
    - プレミアムユーザが１０名以上所属しているサークルはメンバーの最大数が５０名に引き上げられる
  ```

- アプリケーションサービスにドメインのルールに基づくロジックを記述する必要がある
  - でないとドメインオブジェクトはルールを何も語らない
  - かつドメインの重要なルールはサービスのあちらこちらに記述されるようになってしまう
- Circle クラスに書きたいところだが、ユーザ情報は識別子（UserId）しか保持していない
  - 識別子からユーザ情報を取得するにはリポジトリが必要
- エンティティや値オブジェクトがドメインモデルの表現に専念するためには、リポジトリを操作することを可能な限り避ける必要がある

### 「仕様」による解決

- エンティティや値オブジェクトにリポジトリを操作させないため、サークルが満員かの評価を「仕様」として切り出す
  - 複雑な評価手順を切り出すことで趣旨が明確になる

### リポジトリの仕様を避ける

- 仕様=ドメインオブジェクト内部でリポジトリを使用することを避ける考え方もある
- ファーストクラスコレクションを利用する選択
  - ファーストクラスコレクション=特化した集合オブジェクトを用意するパターン

## 13-2 仕様とリポジトリを組み合わせる

- 仕様は単独での取り扱い以外に、リポジトリと組み合わせる手法もある
  - リポジトリに仕様を引き渡して、仕様に合致するオブジェクトを検索する
- リポジトリには検索を行うメソッドが定義されるが、検索処理の中には重要なルールを含むものが存在する
  - 重要なルールがリポジトリに記述されてしまう恐れがある
  - 重要なルールは仕様オブジェクトに定義してからリポジトリに引き渡す

### お勧めサークルに見る複雑な検索処理

TODO: サンプルコードの追加

- お勧めサークルの検索機能を開発することを考えてみる
- お勧めサークルの定義をまず決める
  ```
    - 直近1ヶ月以内に結成されたサークルである
    - 所属メンバー数が10名以上である
  ```
- お勧めサークルの検索を行う処理はリポジトリに定義する
  - ユーザやサークルの検索はこれまでリポジトリで行ってきたため

### 仕様とリポジトリが織りなすパフォーマンス問題

- 仕様をリポジトリに引き渡す手法は残念ながらデメリットが存在する
- 仕様に合致するかはオブジェクトを生成して仕様に引き渡し、検索を行わない限りわからない
- 結果的に全件検索を行い、一つずつ条件に適合するか確認している
  - そのため、数万件とデータが存在していた場合ひどく遅い処理になる恐れがある
- 仕様をリポジトリのフィルターとして扱うときは、パフォーマンスのことを常に考慮する必要がある

### 複雑なクエリは「リードモデル」で

- お勧めサークルの検索処理のように特殊な条件下にあるオブジェクトを検索したいという要求は、便利なソフトウェアを開発していく上で必要になる
  - パフォーマンスへの要求も高くなりがち
- こういった事情のあるときは仕様やリポジトリといったパターンを扱わないことをも視野に入る
- アプリケーションサービスそうにサークル一覧を取得し、そのサークルのオーナーとなるユーザの情報を取得するスクリプトを追加する
  - この処理には２つ問題がある
  - １つ目は全てのサークルが必要ではないにも関わらず、サークルを全件取得している。
  - ２つ目はサークルに所属するユーザの検索処理が繰り返し文によって何度も行われている
    - SQL なら JOIN 区などを活用して１回のクエリ文だけで済むはず
    - ORM を活用しても構わない

## まとめ

- オブジェクトの評価はそれ単体で知識になり得る
- 仕様は評価の条件や手順をモデルにしたオブジェクト
- オブジェクトの評価は
  - オブジェクト自身にさせることが常に正しいとは限らない
  - 仕様のように外部のオブジェクトに評価させるほうが素直なコードになることも多い
- 残念ながら仕様をリポジトリに引き渡す手法はパフォーマンス上の問題がつきまとう
  - クライアントが利用しなやすい形で提供する必要がある
