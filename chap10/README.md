# １０章 データの整合性を保つ

- システムにはデータの整合性を保つことが求められる
- 一般的に整合性を保つために利用されるのはトランザクション
- 本章ではトランザクションをどのように扱うを主軸に解説する

## １０-１ 整合性とは

- システムにはデータの整合性を求められる処理が存在する
- 整合性：「矛盾がなく一貫性のあること・ズレがないこと」
- 商品を注文するときの注文明細を例に考える
  - 注文明細には以下が記載されている
    - ヘッダ部：注文者の名前や住所などの情報
    - ボディ部：注文した商品やその個数の情報
  - ヘッダ部かボディ部のどちらかが欠けても注文書は成り立たない
  - 注文明細のヘッダ部・ボディ部には「常に互いが存在する一貫性」=「整合性」が必要
- プログラムが不正終了した場合、ヘッダ部・ボディ部のどちらかが欠ける可能性がある
- 本章ではこういった問題を防ぐための、データの整合性を担保する方法について解説する
  - データの整合性を保つことはソフトウェアを構築する上で必ず必要になる

## １０-2 致命的な不具合を確認する

TODO：サンプルコードを追加する

- これまで作ってきたソフトウェアに実は致命的な不具合がある
- 致命的な不具合はユーザ登録処理にある
  - 問題は「ユーザ名が重複することを許可しない」ルール
  - 最初の利用者がユーザ登録処理を実行したとき、もう一方の利用者が同じユーザ名で登録すると、重複チェックをすり抜けてしまう不具合

## 10-3 ユニークキー制約による防衛

- アプリケーション全体でユーザ名が重複しないように、データの整合性を保つための手段として、「ユニークキー制約」がある
- ユニークキー制約：データベースの特定のカラムがユニーク（唯一無二）のものであることを保証する機能
  - もしこの制約に違反するレコードの挿入を行った場合はエラーを出してくれる
- データの整合性を守るためには積極的に利用すべき

### ユニークキー制約を重複確認の主体としたときの問題点

- ユニークキー制約は使い方を謝るとコードの表現力が奪われる
- サンプルコードからユーザの重複確認を削除する
  - このとき２点問題点がでてしまう
    - １つ目：重複に関するルールがあることをコードから読み取れなくなる
    - ２つ目：データベースのユニークキー制約という特定の技術基盤に依存している
  - 第７章で、ビジネスロジックが特定の技術基盤に依存するのは避けるべきと言及済み
  - 重複ルールがユーザ名からメールアドレスに変更された場合、開発者は（サンプルコードの状態だと）リレーショナルデータベースのテーブルの制約を変更しなければいけないことに気づけない

### ユニークキー制約との付き合い方

- ユニークキー制約はルールを守る主体ではなく、セーフティネットとして活用されるべき機能
  - コードの重複ルール確認を「メールアドレスの確認」として間違えて定義しているとする
  - このとき、ユニークキー制約がユーザー名に設定されていれば、ユーザー名が重複して登録してもプログラムが例外を発生して終了してくれる
- コードから重複の確認を省略することはおすすめできない

## 10-4 トランザクションによる防衛

- データの整合性を保つために利用される一般的な手段として、データベースのトランザクション機能がある
- トランザクションは一貫した状態を保つために、相互依存的な操作の完了ないし取消を保証する

### トランザクションを取り扱うパターン

- トランザクションを扱うにはデータベースコネクションを使い回す必要がある
  - 注釈）C#や Java は標準のライブラリで利用できる
- リポジトリにデータベースコネクションを受け取るように修正
- トランザクションの開始やコミット処理を制御するためにアプリケーションサービスも同様に修正
- しかしこれだとアプリケーションサービスが、依存してしまっている
  - リポジトリの実体がリレーショナルデータベースではなく、InMemory な場合もありうる
- 整合性を保ちながら特定の技術基盤に依存せずに済むパターンをいくつか紹介する

### トランザクションスコープを利用したパターン

- 整合性を保つトランザクション処理はデータベースに限ったことではない
- C#には整合性を保つ処理であることを主張できるトランザクションスコープという機能が存在する
  - 実際にトランザクションを開始するような動作はしない
  - あくまでもトランザクションを行う範囲の定義を行う

### AOP を利用したパターン

- トランザクションスコープについて、Java ではアスペクト指向プログラミング(AOP)に基づいたアプローチで同じことを実現している
  - AOP はソースコードに変更を加えずに新たな処理を追加することを実現する
  - @Transaction アノテーションでトランザクションスコープと同じことを実現

### ユニットオブワークを利用したパターン

TODO: 内容を追記する

- ユニットオブワークのパターンもトランザクションを取り扱うための選択肢の一つ

### トランザクションが引き起こすロックについて

- データベースのトランザクションは一貫性を保証するためにデータをロックする
- トランザクションを利用するにあたって、どれほどろっくされるかは常に念頭に置く必要がある
  - トランザクションが引き起こすロックは可能な限り小さくすべき
  - ロックが広範囲になると失敗する可能性が上がる

## まとめ

- データの整合性を保つためのトランザクションを制御する方法はいくつかある
- どの方法が現在のプロダクトに最適なのかを考えて採用すべき方法を選ぶべき
