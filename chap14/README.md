# 第１４章 アーキテクチャ

- ドメイン駆動設計と同時に語られるアーキテクチャを解説する
- ドメイン駆動設計はドメインと向き合いながらモデルをコードに落とし込むことで、ドメインとコードを結びつけるプラクティス
- そのため特定のアーキテクチャを前提にしない
- それにもかかわらず、ドメイン駆動設計と同時にアーキテクチャが語られることが多い
- ソフトウェアの継続的な改良に耐えうる構造に必要に駆られて、一つのモデルの変更がいくつものオブジェクトに変更につながる恐れがある
  - アーキテクチャはこれを解決にする
  - ドメインのルールが流出することを予防する（※ドメイン駆動設計の役割）のと同時に一箇所にまとめるよう促す
- 従ってドメイン駆動設計とアーキテクチャが同時に語られる

## 14-1 アーキテクチャの役目

- アーキテクチャは開発者の心を躍らせるもの
- ただしドメイン駆動設計にとって「アーキテクチャは決して主役ではない」
- アーキテクチャ自体を学ぶ前に、まずドメイン駆動設計にとってアーキテクチャがどのような立ち位置であるか確認する

### アンチパターン：利口な UI

- 利口な UI：本来であればドメインオブジェクトに記載されるべき重要なルールや振る舞いが、ユーザーインターフェイスに記述されてしまっている状態
- ドメインを分離することが適わなかったアプリケーションに多く見られる
- EC サイトのシステムを例に考えてみる
- EC サイトの「注文確認画面」「注文履歴一覧画面」「注文履歴確認画面」には共通の「注文金額計算」ロジックが入っている
  - この３画面それぞれに「注文金額計算」ロジックが入っていた場合、それぞれの画面特有の事情によって独自に成長していく
  - 同じように見えるコードはわずかに異なり、慎重に修正を加える必要が出てくる
- ひとりの開発者がこの３画面を手掛けるなら、「注文金額計算」ロジックの共通化に気づき、修正を図りやすい
- 真に問題となるのは初期段階で３画面のうち１つしかなかった場合
  - 同じ計算を他の箇所でも利用することが発生したときのことが頭の片隅にすぎることはあるかもしれない
  - 開発者はいつかリファクタリングをすべきタイミングが訪れる夢を信じがち。ただしそんなときは訪れない
  - 複雑怪奇な進化をとげたコードがいつの日か開発者の前に立ちはだかる
- UI はできるだけ愚かであるべき
  - UI は入力と表示が責務
  - ビジネスに係るようなロジックは可能な限り記述されるべきではない
  - 画面固有の事情が「注文金額の計算」に入り込む余地はない
  - また計算ロジックに変更があっても１箇所の回収で済む
- まずは、今開発しているソフトウェアがひどく単純庵ものという先入観を捨てるべき
- ユーザインターフェースにビジネスロジックを記述することが肯定された時点で、豊かなドメインモデルを育てていく輝かしい道のりは閉ざされる

### ドメイン駆動設計がアーキテクチャに求めること

- 利口な UI を避けることに決めたとしても、それを実際に実践するのはそう簡単なことではない
- 開発者に強い自制心を促す以外の方法を考える必要がある → アーキテクチャはその１例
- アーキテクチャは方針
- 開発者はアーキテクチャが示す方針にしたがうことで「何をどこにかくのか」に振り回されないようになる
  - ドメイン駆動設計の本質である「ドメインを捉え、うまく表現する」ことに集中するために必要
- ドメイン駆動摂家がアーキテクチャに求めることは、
  - ドメインオブジェクトが渦巻くレイヤーを隔離し、ソフトウェア特有の事情からドメインオブジェクトを防衛すること
- それが可能ならアーキテクチャは何でもよい

## 14-2 アーキテクチャの解説

- 次のアーキテクチャはドメイン駆動設計と同時に語られることが多い

  - レイヤードアーキテクチャ
  - ヘキサゴナルアーキテクチャ
  - クリーンアーキテクチャ

- ドメイン駆動設計にとってはドメインが隔離されることのみが重要なので、必ずしも上記アーキテクチャに従う必要はない
- 逆にアーキテクチャに従う=ドメイン駆動設計に実践**ではない**
- ドメインの本質に集中する環境を用意することが重要

### レイヤードアーキテクチャとは

- レイヤードアーキテクチャ：今回挙げた３つの中で最も伝統的＆有名なアーキテクチャ
- いくつかの層で積み重なる形で表現される
  - ４つの層で構成されたものが代表的
- ４つの層の内訳は次のとおり
  - プレゼンテーション層（ユーザーインターフェイス層）
  - アプリケーション層
  - ドメイン層
  - インフラストラクチャ層
- ドメイン層
  - 内訳の中で最も重要な層
  - ソフトウェアを適用している領域で問題解決に必要な知識を表現する
  - この層を明示的にすることで、他の層へ流出しないようにする
- アプリケーション層
  - ドメイン層の住人を取りまとめる層
  - アプリケーション層の住人にはアプリケーションサービスが挙げられる
- プレゼンテーション層
  - ユーザーインターフェイスとアプリケーションを結びつける
  - 主な責務は
    - システムの利用者にわかるように「表示」を行う
    - システム利用者の入力を「解釈」する
  - 具体的なアプローチは Web フレームワークでも CLI でもよい
- インフラストラクチャ層
  - 他の層を支える技術的基盤へのアクセスを提供する層
  - ドメインのための永続化を行うモジュールが含まれる
- 今回のレイヤーは上位のレイヤーは自身より下位のレイヤーに依存することが許される反面、逆方向の依存はゆるされない

### ヘキサゴナルアーキテクチャとは

- ヘキサゴナルアーキテクチャ：六角形をモチーフとしたアーキテクチャ
- アプリケーションとそれ以外のインターフェイスや保存媒体はつけ外しできるようにする
- ゲーム機が良いたとえになる
  - コントローラやモニターといった利用者が直接触れることのできるインターフェイスは純正品もサードパーティ製も使える
  - 記憶媒体もゲーム機内臓のハードディスクだけでなく、近年はクラウド上に保存できる
  - ゲーム機にとっては正常に動作できればどんな手段も使っても構わない
- アプリケーションにとっても保存媒体やインタフェースは差し替え可能なもの
  - インスタンスの永続化と再構築さえこえすことができれば媒体は何でも問題ない

### クリーンアーキテクチャとは

- クリーンアーキテクチャ：４つの同心円が特徴的な図によって説明されるアーキテクチャ
  - ビジネスルールをカプセル化したモジュールを中心に捉えるというコンセプト
- クリーンアーキテクチャでいうエンティティはドメインオブジェクトに近い概念
  - ビジネスルールをカプセル化したオブジェクトなし、データ構造と関数のセットを指す
- ユーザインターフェースやデータストアなどの詳細を端に追いやり、依存の方向を内側にむけることで、詳細が抽象に依存するという依存関係逆転の原則を達成する
- ヘキサゴルアーキテクチャと目的が同じ
- 違いは
  - ヘキサゴルアーキテクチャ：ポートとアダプタによりつけ外しを可能にするという方針だけ
  - クリーンアーキテクチャ：コンセプトを実現する具体的な実装方針が明示されている
- ドメイン駆動設計でもっとも重要なことはドメインの隔離を促すこと
  - すべての詳細がドメインに対して依存するようにすることで、ソフトウェアの方針をもっとも重要なドメインに握らせることを可能に

## 14-3 まとめ

- アーキテクチャには共通点として「一度に多くのことを考えすぎない」ことがある
- アーキテクチャは方針を示し、各所で考える範囲を狭めることで集中を促す
- 本章で紹介したアーキテクチャに固執する必要はない
- ドメイン駆動設計においてアーキテクチャは主役ではない
